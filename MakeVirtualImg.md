# MYTOS虚拟镜像文件的生成 #

> 源文件在/tool/imgTool.c 和/tool/imgTool.h,这两个文件不和其他文件有什么联系，自成一个小的程序
> 这个文档主要是简单介绍下MYTOS是怎么产生虚拟软盘镜像文件的，以及怎么加载到内存中的，这就包括了它的启动加载程序。
> 我想写文档最重要的一点是要让别人很容易读得懂，而不是读了也不知道所云，我希望文档是尽量别和上下文相关的，意思就是即使你对内核，MYTOS不是很清楚，只需要正常人的逻辑就可以读懂，当然这只是期望，尽量做到这一点吧。

> 现在在计算机上我们写的程序只需要直接运行就可以了，而无需指明要放在内存的什么地方，同样的一个2G的U盘，里面放了很多文件，我们也不知道它是放在什么位置的，但产生一个虚拟镜像文件要做的是把几个"程序"放在一起并指定他们的位置。

**1. 什么叫把几个"程序"放在一起呢，把如你有1.txt(1234B大),2.txt(3214B大),3.txt(2231B大),放在一起就相当于合并成一个文件，大小为6679B大(假设文件名叫4.txt)。**

**2. 为什么要指定他们的位置呢，因为你必须清楚他们几个文件在一个文件里的什么位置才能操作他们，比如1.txt,2.txt,3.txt 他们依次合并，那么文件在文件4.txt(大小为6679B)里，从文件头开始的1235B-4448B都是2.txt文件的内容，当然你也可以把3.txt放在中间。**

> 一个虚拟镜像文件其实就是一个1440K的文件，比如他的名字叫A.txt，名字其实是无所谓的，只要他的大小可以就行了，只要他里面的内容符合一些特征就行了，那么用这个虚拟镜像的文件可以从虚拟机上启动了。所以你可以在C里面使用fopen创建一个文件，指定它的大小为1440K就行了，这样就可以参数虚拟镜像文件了。

> 来看看/tool/imgTool.c，假设我们把启动程序，内存管理程序，文件系统程序编译好了，他们是以bin文件的形式存在。其实他们和1.txt,2.txt,3.txt都一样，都是二进制，你也可以把这些文件改为1.txt,2.txt,3.txt，当然在这里他们的名字是boot.bin，memory.bin,filesys.bin。这样你可以用C中以读的方式open这些文件，读取他们到一个字符数组中，比如字符数组char buffer[1440\*1024]，把这三个文件的内容读进来就可以了，然后把整个缓冲区buffer里的内容写入那个你自己以写的方式打开的一个文件kernel.img，这样虚拟镜像文件就产生了。

> 这是大概的内容，我们处理的时候建立了个简单的"文件系统"，其实就是一个链表，每个节点包含一个文件，在上

面这里的话就是有3个节点，然后我们再定义一个头节点。
头节点包含了整个虚拟镜像文件的信息，同时指向第一个节点（第一个文件）
头节点

typedef struct sfs\_head{

> int sectors ;

> int file\_num ;

> SFS**header ;**

> char info [100 ] ;

}SFS\_HEAD;

节点

typedef struct sfs
{
> char name [20 ] ;

> int sectors ;

> int start\_sec ;

> char path [20 ] ;

> struct sfs**next ;**

}SFS;

> 我们这里又加工了下，在目录configure下面可以配置文件的顺序，这个imgTool文件会去读取那个configure目录下

的文件来得知有几个文件，他们的名字是什么，以把这些文件加载到虚拟镜像文件中。